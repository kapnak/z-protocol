# Z Protocol

*Version 1.4.1*

Z Protocol is a network communication protocol over TCP. It provide a request / reply communication model with encryption and authentication.


## Features
- Message-oriented
- Request / Reply model
- Encryption & Authentication (Optional)
- Easy routing without decryption


## Implementation
- C (Linux) : https://github.com/kapnak/zprotocol-c
- JavaScript : https://github.com/kapnak/z-js


## Definition
- **`libsodium`** - https://doc.libsodium.org/
- **`public key`** - A raw 32 bytes libsodium Ed25519 key pair.
- **`header`** - 24 bytes generated by libsodium `crypto_secretstream_xchacha20poly1305_init_push` and needed for the other end to decrypt payloads.
- **`client`** - The peer initiating the TCP connection.
- **`server`** - The peer receiving the TCP connection.
- **`message`** - A request or a reply sent by a peer.


## Cryptography
The protocol uses Ed25519 key pairs.  
The protocol assumes the client knows the server's public key from trusted a source.  
A shared key is computed on both sides using the ECDH key exchange. To be done, the peers convert their Ed25519 key pair to X25519 key pairs and then use the ECDH algorythm.  
The payloads are encrypted using the XChaCha20-Poly1035 cipher with the shared keys through the `crypto_secretstream_xchacha20poly1305_*` libsodium API.


## Protocol

### Client Initialization
The first bytes sent by the client need to be as follows :

```
\0{server_pk}{client_pk}{header}
```

| Name      | Bytes | Description                                                                 |
| --------- | ----- | --------------------------------------------------------------------------- |
| \0        | 1     | A 0 null char                                                               |
| server_pk | 32    | The server public key                                                       |
| client_pk | 32    | The client public key                                                       |
| header    | 24    | The [header](#definition) or all bytes to 0 for non-encrypted communication |

> [!IMPORTANT]
> The server cannot send any message until the client sends his initialization bytes.  


### Server Initialization
The server has to wait for the client to sends his initialization bytes.  
If the [header](#definition) received from the client is not empty (all bytes to `0`) the server send his initialization bytes :
```
{header}
```
| Name   | Bytes | Description                                   |
| ------ | ----- | --------------------------------------------- |
| header | 24    | The [header](#definition) used for decryption |

> [!NOTE]
> If the client has initiated a non-encrypted communication by sending an empty [header](#definition), the server doesn't have any initialization bytes to send.


### Message

```
{id}{length}{payload}
```
| Name    | Bytes    | Description                                                  |
| ------- | -------- | ------------------------------------------------------------ |
| id      | 16       | The message id, see [generating the id](#generate-the-id-)   |
| length  | 4        | The payload size (unsigned int)                              |
| payload | {length} | The message content encrypted if the connection is encrypted |


#### Generate the ID :

For a **request** :  
The `id` is 16 random bytes with the smallest bit of the first byte set to `0`.

For a **reply** :  
The `id` is the `id` of the request to which the message replies to with the smallest bit of the first byte set to `1`.
